name: CI/CD Pipeline

env:
    IMAGE_NAME: emogi-app
    CONTAINER_NAME: emogi-app
    PROJECT_PATH: /home/isakin/project/emogi

on:
    push:
        branches: ["main", "develop"]

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
                token: ${{ secrets.ACCESS_TOKEN }}

          - name: Get and update version
            id: version
            run: bash ./scripts/update_version.sh "${{ github.ref }}" "${{ github.run_number }}"

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

          - name: Login to DockerHub
            uses: docker/login-action@v3.3.0
            with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

          - name: Build and push Docker image
            uses: docker/build-push-action@v6.7.0
            with:
                context: .
                file: ./Dockerfile
                push: true
                tags: |
                    ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
                    ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

    deploy-to-server:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Deploy to server and update containers
            uses: appleboy/ssh-action@master
            with:
                host: ${{ secrets.SSH_HOST }}
                port: ${{ secrets.SSH_PORT }}
                username: ${{ secrets.SSH_USERNAME }}
                password: ${{ secrets.SSH_PASSWORD }}
                source: "docker-compose.yml,scripts/deploy.sh"
                script: |
                    # Copy files to project directory
                    mkdir -p ${{ env.PROJECT_PATH }}
                    cp docker-compose.yml ${{ env.PROJECT_PATH }}/
                    cp scripts/deploy.sh ${{ env.PROJECT_PATH }}/
                    
                    # Move to project directory and execute deploy script
                    cd ${{ env.PROJECT_PATH }}
                    bash ./deploy.sh "${{ env.PROJECT_PATH }}" "${{ secrets.DOCKER_USERNAME }}" "${{ env.IMAGE_NAME }}" "${{ needs.build-and-push.outputs.version }}"

    notify:
        needs: [build-and-push, deploy-to-server]
        runs-on: ubuntu-latest
        if: always()
        steps:
          - name: Discord notification
            env:
                DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
                DISCORD_EMBEDS: |
                    [{
                        "title": "üöÄ ${{ github.repository }} Î∞∞Ìè¨ Í≤∞Í≥º",
                        "description": "GitHub Actions ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ Í≤∞Í≥º",
                        "color": "${{ needs.build-and-push.result == 'success' && needs.deploy-to-server.result == 'success' && '5763719' || '15548997' }}",
                        "fields": [
                            {
                                "name": "Ï†ÄÏû•ÏÜå",
                                "value": "${{ github.repository }}",
                                "inline": true
                            },
                            {
                                "name": "Î∏åÎûúÏπò",
                                "value": "`${{ github.ref_name }}`",
                                "inline": true
                            },
                            {
                                "name": "Î≤ÑÏ†Ñ",
                                "value": "`${{ needs.build-and-push.outputs.version }}`",
                                "inline": true
                            },
                            {
                                "name": "Ïª§Î∞ã Î©îÏãúÏßÄ",
                                "value": "${{ github.event.head_commit.message }}"
                            },
                            {
                                "name": "ÎπåÎìú ÏÉÅÌÉú",
                                "value": "${{ needs.build-and-push.result == 'success' && '‚úÖ ÏÑ±Í≥µ' || '‚ùå Ïã§Ìå®' }}"
                            },
                            {
                                "name": "Î∞∞Ìè¨ ÏÉÅÌÉú",
                                "value": "${{ needs.deploy-to-server.result == 'success' && '‚úÖ ÏÑ±Í≥µ' || '‚ùå Ïã§Ìå®' }}"
                            }
                        ],
                        "footer": {
                            "text": "GitHub Actions"
                        },
                        "timestamp": "${{ github.event.head_commit.timestamp }}"
                    }]
            uses: Ilshidur/action-discord@master